version: '3.8'

services:
  # Minimal Alpine base for basic testing
  alpine-base:
    build:
      context: .
      dockerfile: alpine-base.Dockerfile
    volumes:
      - ../scripts:/home/testuser/test-scripts:ro
      - ../fixtures:/home/testuser/test-fixtures:ro
      - /tmp/chezmoi-test-alpine:/home/testuser/test-output
    environment:
      - TEST_MACHINE_TYPE=default
    working_dir: /home/testuser
    command: ["sleep", "infinity"]

  # macOS simulation for macOS-specific testing
  macos-sim:
    build:
      context: .
      dockerfile: macos-sim.Dockerfile
    volumes:
      - ../scripts:/home/testuser/test-scripts:ro
      - ../fixtures:/home/testuser/test-fixtures:ro
      - /tmp/chezmoi-test-macos:/home/testuser/test-output
    environment:
      - TEST_MACHINE_TYPE=mac-mini
    working_dir: /home/testuser
    command: ["sleep", "infinity"]

  # MacBook Air simulation
  macbook-air-sim:
    build:
      context: .
      dockerfile: macos-sim.Dockerfile
    volumes:
      - ../scripts:/home/testuser/test-scripts:ro
      - ../fixtures:/home/testuser/test-fixtures:ro
      - /tmp/chezmoi-test-macbook:/home/testuser/test-output
    environment:
      - TEST_MACHINE_TYPE=macbook-air
    working_dir: /home/testuser
    command: ["sleep", "infinity"]

  # Performance testing container
  performance-tester:
    build:
      context: .
      dockerfile: performance.Dockerfile
    volumes:
      - ../scripts:/home/perfuser/test-scripts:ro
      - ../integration:/home/perfuser/test-integration:ro
      - /tmp/chezmoi-perf-results:/home/perfuser/test-results
    environment:
      - TEST_MODE=performance
      - PERFORMANCE_SCENARIO=medium
    working_dir: /home/perfuser
    command: ["sleep", "infinity"]
    
  # Load testing container (high resource usage)
  load-tester:
    build:
      context: .
      dockerfile: performance.Dockerfile
    volumes:
      - ../scripts:/home/perfuser/test-scripts:ro
      - ../integration:/home/perfuser/test-integration:ro
      - /tmp/chezmoi-load-results:/home/perfuser/test-results
    environment:
      - TEST_MODE=load_testing
      - PERFORMANCE_SCENARIO=extreme
    working_dir: /home/perfuser
    cpus: "2.0"
    mem_limit: 1g
    command: ["sleep", "infinity"]